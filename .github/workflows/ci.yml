name: ci

on:
  push:
  pull_request:

jobs:
  secret-scan:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Ensure .env is not tracked
        run: |
          if git ls-files --error-unmatch .env > /dev/null 2>&1; then
            echo "::error::.env must never be tracked in git."
            exit 1
          fi

      - name: Run repository secret scan
        run: python scripts/secret_guard.py --mode repo

  lint:
    runs-on: ubuntu-latest
    needs: [secret-scan]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Poetry
        run: pip install poetry==1.8.4

      - name: Install dependencies
        run: poetry install --no-interaction --with dev

      - name: Run lint checks
        run: poetry run ruff check app tests

  ops-config:
    runs-on: ubuntu-latest
    needs: [lint]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate production compose syntax
        run: docker compose -f docker-compose.prod.yml config -q

      - name: Validate Prometheus config
        run: |
          docker run --rm --entrypoint promtool -v "$PWD/ops/prometheus:/etc/prometheus:ro" \
            prom/prometheus:v3.5.0 check config /etc/prometheus/prometheus.yml

      - name: Validate Prometheus alert rules
        run: |
          docker run --rm --entrypoint promtool -v "$PWD/ops/prometheus:/etc/prometheus:ro" \
            prom/prometheus:v3.5.0 check rules /etc/prometheus/alerts.yml

      - name: Validate Alertmanager config
        run: |
          docker run --rm --entrypoint amtool -v "$PWD/ops/alertmanager:/etc/alertmanager:ro" \
            prom/alertmanager:v0.28.1 check-config /etc/alertmanager/alertmanager.yml

  test:
    runs-on: ubuntu-latest
    needs: [lint, ops-config]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Poetry
        run: pip install poetry==1.8.4

      - name: Install dependencies
        run: poetry install --no-interaction --with dev

      - name: Run tests
        run: poetry run pytest -q

  migration:
    runs-on: ubuntu-latest
    needs: [lint, ops-config]
    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: guitaronline
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U postgres -d guitaronline"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 10
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Poetry
        run: pip install poetry==1.8.4

      - name: Install dependencies
        run: poetry install --no-interaction --with dev

      - name: Run migrations
        env:
          DATABASE_URL: postgresql+asyncpg://postgres:postgres@localhost:5432/guitaronline
        run: poetry run alembic upgrade head

  integration:
    runs-on: ubuntu-latest
    needs: [migration]
    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: guitaronline
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U postgres -d guitaronline"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 10
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Poetry
        run: pip install poetry==1.8.4

      - name: Install dependencies
        run: poetry install --no-interaction --with dev

      - name: Apply migrations
        env:
          DATABASE_URL: postgresql+asyncpg://postgres:postgres@localhost:5432/guitaronline
        run: poetry run alembic upgrade head

      - name: Start API server
        env:
          DATABASE_URL: postgresql+asyncpg://postgres:postgres@localhost:5432/guitaronline
          AUTH_RATE_LIMIT_TRUSTED_PROXY_IPS: 127.0.0.1,::1
        run: |
          poetry run uvicorn app.main:app --host 0.0.0.0 --port 8000 > api.log 2>&1 &
          echo $! > api.pid

      - name: Wait for API healthcheck
        run: |
          for i in {1..45}; do
            if curl -fsS http://localhost:8000/health > /dev/null; then
              echo "API is ready"
              exit 0
            fi
            sleep 2
          done
          echo "API failed to start in time"
          cat api.log
          exit 1

      - name: Run HTTP integration tests
        env:
          INTEGRATION_BASE_URL: http://localhost:8000/api/v1
          INTEGRATION_HEALTH_URL: http://localhost:8000/health
          INTEGRATION_DB_DSN: postgresql://postgres:postgres@localhost:5432/guitaronline
        run: poetry run pytest -q tests/test_booking_billing_integration.py

      - name: Dump API log on failure
        if: failure()
        run: cat api.log

      - name: Stop API server
        if: always()
        run: |
          if [ -f api.pid ]; then
            kill "$(cat api.pid)" || true
          fi
