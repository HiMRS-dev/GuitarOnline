name: deploy

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      ref:
        description: "Git ref to deploy (branch, tag, or commit SHA)"
        required: true
        default: "main"
      profile:
        description: "Compose runtime profile"
        required: true
        type: choice
        options:
          - standard
          - proxy
        default: standard
      run_backup:
        description: "Create pre-deploy DB backup"
        required: true
        type: boolean
        default: true
      run_smoke:
        description: "Run post-deploy smoke checks"
        required: true
        type: boolean
        default: true
      confirm:
        description: "Type DEPLOY to confirm"
        required: true

concurrency:
  group: deploy-${{ github.ref_name }}
  cancel-in-progress: false

jobs:
  deploy:
    if: ${{ (github.event_name == 'workflow_dispatch' && github.event.inputs.confirm == 'DEPLOY') || github.event_name == 'push' }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
    env:
      DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
      DEPLOY_PORT: ${{ secrets.DEPLOY_PORT }}
      DEPLOY_USER: ${{ secrets.DEPLOY_USER }}
      DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}
      DEPLOY_KNOWN_HOSTS: ${{ secrets.DEPLOY_KNOWN_HOSTS }}
      DEPLOY_SSH_PRIVATE_KEY: ${{ secrets.DEPLOY_SSH_PRIVATE_KEY }}
      PROD_ENV_FILE_B64: ${{ secrets.PROD_ENV_FILE_B64 }}
      AUTO_DEPLOY_ENABLED: ${{ secrets.AUTO_DEPLOY_ENABLED }}
      REF_NAME: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.ref || github.sha }}
      PROFILE: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.profile || 'standard' }}
      RUN_BACKUP: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.run_backup || 'true' }}
      RUN_SMOKE: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.run_smoke || 'true' }}
      TRIGGER_SOURCE: ${{ github.event_name }}
      REPO_URL: ${{ github.server_url }}/${{ github.repository }}.git
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ env.REF_NAME }}

      - name: Evaluate auto-deploy guard
        id: auto_deploy_guard
        run: |
          set -euo pipefail
          if [ "${TRIGGER_SOURCE}" = "push" ] && [ "${AUTO_DEPLOY_ENABLED:-}" != "true" ]; then
            echo "enabled=false" >> "$GITHUB_OUTPUT"
            echo "Auto deploy skipped: AUTO_DEPLOY_ENABLED is not true."
            exit 0
          fi
          echo "enabled=true" >> "$GITHUB_OUTPUT"
          echo "Auto deploy guard passed."

      - name: Print deployment context
        if: ${{ steps.auto_deploy_guard.outputs.enabled == 'true' }}
        run: |
          set -euo pipefail
          echo "Trigger source: ${TRIGGER_SOURCE}"
          echo "Repository URL: ${REPO_URL}"
          echo "Deploy host: ${DEPLOY_HOST}"
          echo "Deploy path: ${DEPLOY_PATH}"
          echo "Requested ref: ${REF_NAME}"
          echo "Requested profile: ${PROFILE}"
          echo "Run backup: ${RUN_BACKUP}"
          echo "Run smoke: ${RUN_SMOKE}"
          echo "Bootstrap mode: auto (repo initialized if ${DEPLOY_PATH} has no .git)"

      - name: Validate required secrets
        if: ${{ steps.auto_deploy_guard.outputs.enabled == 'true' }}
        run: |
          set -euo pipefail
          required=(
            DEPLOY_HOST
            DEPLOY_USER
            DEPLOY_PATH
            DEPLOY_SSH_PRIVATE_KEY
            PROD_ENV_FILE_B64
          )
          for name in "${required[@]}"; do
            if [ -z "${!name:-}" ]; then
              echo "::error::Missing required repository secret: ${name}"
              exit 1
            fi
          done
          if [[ "${DEPLOY_PATH}" != /* ]]; then
            echo "::error::DEPLOY_PATH must be an absolute path. Got: ${DEPLOY_PATH}"
            exit 1
          fi
          if [[ "${PROFILE}" != "standard" && "${PROFILE}" != "proxy" ]]; then
            echo "::error::Unsupported profile input: ${PROFILE}"
            exit 1
          fi

      - name: Setup SSH key
        if: ${{ steps.auto_deploy_guard.outputs.enabled == 'true' }}
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.DEPLOY_SSH_PRIVATE_KEY }}

      - name: Configure known hosts
        if: ${{ steps.auto_deploy_guard.outputs.enabled == 'true' }}
        run: |
          set -euo pipefail
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          port="${DEPLOY_PORT:-22}"
          if [ -n "${DEPLOY_KNOWN_HOSTS:-}" ]; then
            printf '%s\n' "${DEPLOY_KNOWN_HOSTS}" > ~/.ssh/known_hosts
          else
            ssh-keyscan -p "${port}" -H "${DEPLOY_HOST}" >> ~/.ssh/known_hosts
          fi
          chmod 644 ~/.ssh/known_hosts

      - name: Upload production env file
        if: ${{ steps.auto_deploy_guard.outputs.enabled == 'true' }}
        run: |
          set -euo pipefail
          remote="${DEPLOY_USER}@${DEPLOY_HOST}"
          port="${DEPLOY_PORT:-22}"

          mkdir -p .tmp
          trap 'rm -f .tmp/prod.env' EXIT
          printf '%s' "${PROD_ENV_FILE_B64}" | base64 -d > .tmp/prod.env

          ssh -p "${port}" "${remote}" "mkdir -p '${DEPLOY_PATH}'"
          scp -P "${port}" .tmp/prod.env "${remote}:${DEPLOY_PATH}/.env"
          ssh -p "${port}" "${remote}" "chmod 600 '${DEPLOY_PATH}/.env'"

      - name: Deploy, migrate, smoke, rollback on failure
        if: ${{ steps.auto_deploy_guard.outputs.enabled == 'true' }}
        run: |
          set -euo pipefail
          remote="${DEPLOY_USER}@${DEPLOY_HOST}"
          port="${DEPLOY_PORT:-22}"

          ssh -p "${port}" "${remote}" "DEPLOY_PATH='${DEPLOY_PATH}' REF_NAME='${REF_NAME}' PROFILE='${PROFILE}' RUN_BACKUP='${RUN_BACKUP}' RUN_SMOKE='${RUN_SMOKE}' REPO_URL='${REPO_URL}' bash -s" < scripts/deploy_remote.sh
